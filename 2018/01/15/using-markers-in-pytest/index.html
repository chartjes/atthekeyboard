<!DOCTYPE html>
<html>
    <head>
        <title>Using markers in pytest &mdash; @TheKeyboard &mdash; The ramblings of a grumpy programmer</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="/components/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="/components/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
        <link href="/css/style.css" rel="stylesheet" type="text/css" />
        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
            <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <link rel="stylesheet" href="/components/highlightjs/styles/github.css" />
        <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="@TheKeyboard activity feed" />
        <link href="https://vjs.zencdn.net/5.5.3/video-js.css" rel="stylesheet">
        <script src="https://vjs.zencdn.net/ie8/1.1.1/videojs-ie8.min.js"></script>
        <style>
        /** quick fix because bootstrap <pre> has a background-color. */
        pre code { background-color: inherit; }
        </style>
    </head>
    <body>
        <header>
            <div class="navbar navbar-inverse navbar-fixed-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="/">@TheKeyboard</a>
                        <div class="nav-collapse collapse">
                            <ul class="nav">
                                <li><a href="/blog">Posts Archive</a></li>
                                <li><a href="/about">About</a></li>
                                <li><a href="/atom.xml">RSS/Atom</a></li>
                            </ul>
                        </div><!--/.nav-collapse -->
                    </div>
                </div>
            </div>
        </header>
        <div class="mainContent container">
            <div class="row-fluid">
                <div class="span8">
                        <article>
        <header>
            <h2>Using markers in pytest <small>post</small></h2>
            <h3>January 15th, 2018</h3>
        </header>
        <div>
            <p>At the <a href="https://mozilla.com">current day-job</a> I use <a href="https://docs.pytest.org/en/latest">pytest</a>
for writing what I call "configuration tests" for the various services
and tools that I am responsible for doing QA work for.</p>

<p>One of these is <a href="https://github.com/Kinto/">Kinto</a>, a "generic JSON
document store" that we wrote (and open-sourced) at Mozilla and is
used by a lot of services.</p>

<p>These days there are three "flavours" of Kinto that I have to worry about:</p>

<ul>
<li><code>kinto-dist</code> which is the core of Kinto</li>
<li><code>kinto-settings</code> which is the Kinto core plus a bunch of records representing settings stored for users of Firefox</li>
<li><code>kintowe</code> which is the Kinto core and some extensions for it that we use to track records of what web extensions Firefox users have stored</li>
</ul>

<p>Whenever we have a new version of any of these "flavours" that need
to be tested, it is deployed to a target environment (either staging
or production) and tests that I wrote are run by our operations team's
deployment tool making a call to a CI server run by the QA department.
This CI server then runs all the tests I wrote.</p>

<p>But I had a problem. There were some tests that needed to be run no
matter what "flavour" we were deploying, and then some tests that
belong only to one "flavour". Previously I just had duplicate repos
but wanted to consolidate them.</p>

<p>I enlisted the help of one of our team tool-makers <a href="https://twitter.com/davehunt82">Dave Hunt</a>
while at our All-Hands meeting in Austin in December of 2017 to go
over some better strategies and to make better use of our CI server.</p>

<p>After scribbling a lot of stuff on a white board to get Dave up to
speed, he suggested moving all the tests into one repo and using a 
feature of pytest called "markers" to figure out what "flavour" we
were testing.</p>

<p>Note: at the time of writing I was doing this work with Python 3.6.3
and pytest 3.3.2.</p>

<p>Pytest makes heavy use of decorators to extend its functionality.
Fixtures (which can be best described as helper methods for tests)
are declared using annotations, and then these fixtures are
available to any test method that you pass it into as a parameter
(with some exceptions based on the scope of a fixture).</p>

<p>Here's an example of a fixture that reads in a configuration file
and returns an object that contains those values:</p>

<pre><code class="python">@pytest.fixture(scope="module")
def conf():
    config = configparser.ConfigParser()
    config.read('manifest.ini')
    return config
</code></pre>

<p>To use it, I just pass it in as a parameter like this:</p>

<pre><code class="python">async def test_server_info(api, conf, env):
    res = await api.server_info()
    data = await res.json()
    expected_fields = aslist(conf.get(env, 'server_info_fields'))

    for key in data:
        assert key in expected_fields

    for field in expected_fields:
        assert field in data
</code></pre>

<p>To use a marker, I simply add an annotation to tell pytest "mark
this test as belonging to <code>dist</code>" or any other "flavour" I want
this test to belong to. Check out the annotations for this test:</p>

<pre><code class="python">@pytest.mark.asyncio
@pytest.mark.dist
@pytest.mark.settings
@pytest.mark.webextensions
async def test_version(api, conf, env, apiversion):
    res = await api.__version__()
    data = await res.json()
    expected_fields = aslist(conf.get(env, 'version_fields'))

    # First, make sure that data only contains fields we expect
    for key in data:
        assert key in expected_fields

    # Then make the we only have the expected fields in the data
    for field in expected_fields:
        assert field in data

    # If we're passed an API version via the CLI, verify it matches
    if apiversion:
        assert apiversion == data['version']
</code></pre>

<p>There is a lot going on here, let me break it down:</p>

<ul>
<li>we are marking this test as being able to run asynchronously using Python 3's <a href="https://docs.python.org/3/library/asyncio.html">asyncio</a> module</li>
<li>we want this test to be run any time we are testing <code>dist</code></li>
<li>we want this test to be run any time we are testing <code>settings</code></li>
<li>we want this test to be run any time we are testing <code>webextensions</code></li>
<li>we are passing in an API helper as a parameter</li>
<li>we are passing in a configuration helper as a parameter</li>
<li>we are passing in a helper that reads a target environment parameter from the CLI</li>
<li>we are passing in a halper that reads an API version parameter from the CLI</li>
</ul>

<p>Here's a test we only want run when we do a <code>kinto-settings</code> deployment:</p>

<pre><code class="python">@pytest.mark.settings
def test_plugins_signatures(env, conf):
    client = Client(
        server_url=conf.get(env, 'reader_server'),
        bucket='blocklists',
        collection='plugins'
    )
    try:
        collection, records, timestamp = get_collection_data(client)
        if len(records) == 0:
            pytest.skip('blocklists/plugins has no records')

        assert verify_signatures(collection, records, timestamp)
        assert verify_signer_id(collection, 'onecrl_key')
    except KintoException as e:
        if e.response.status_code == 401:
            pytest.fail('blocklists/plugins does not exist')
        pytest.fail('Something went wrong: %s %s' % (e.response.status_code, e.response))
</code></pre>

<p>I also needed a way to figure out what markers were set so I could
use the correct value from our configuration file (depending on the
environemnt). Pytest has a <code>request</code> fixture that is globally available
to any test.</p>

<p>I have another helper that uses <a href="https://swagger.io/">Swagger</a> to
parse an API spec that the developers built for me. I pass the
<code>request</code> object to the API helper, and look for specific markers:</p>

<pre><code class="python">@pytest.fixture(scope="module")
def api(event_loop, conf, env, request):
    api_definition = 'dist_api_definition'

    if 'settings' in request.node.keywords:
        api_definition = 'settings_api_definition'
    elif 'webextensions' in request.node.keywords:
        api_definition = 'webextensions_api_definitions'

    return API(conf.get(env, api_definition), loop=event_loop)
</code></pre>

<p>(By the way, you can find all this code in the <a href="https://github.com/Kinto/kinto-integration-tests">GitHub repo</a>
for these tests)</p>

<p>So, when we are doing a deployment of <code>kinto-dist</code> to our staging
environment, we can run the tests this way:</p>

<pre><code class="shell">pytest -m dist --env=stage config-tests/
</code></pre>

<p>Then the tests we want to get run, get run. I'm not sure what
other ways there are to organize your tests, but this is a method
that works and makes sense to me. Got any comments or suggestions?
Email me or contact me via Twitter using details in the sidebar.</p>

        </div>
                
                    <nav class="article">
                <ul>
                                            <li>Next: <a class="next" href="/2018/10/18/codedaze-talk/" title="CodeDaze 2018 Talk"><span class="title">CodeDaze 2018 Talk</span></a></li>
                                                                <li>Previous: <a class="previous" href="/2018/01/14/jan-2018-board-game-night/" title="January 2018 board game night"><span class="title">January 2018 board game night</span></a></li>
                                    </ul>
            </nav>
            </article>
                </div>
                <div class="span4 sidebar">
                    <div class="well">
                        <h4>@TheKeyboard <small>The ramblings of a grumpy programmer</small></h4>
                    </div>
                    <div class="well sidebar-nav">
                        <section>
                            <h3>Find stuff</h3>
                            <script>
                              (function() {
                                var cx = '010269902375244482518:ddxhg1qhod4';
                                var gcse = document.createElement('script');
                                gcse.type = 'text/javascript';
                                gcse.async = true;
                                gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                                    '//www.google.com/cse/cse.js?cx=' + cx;
                                var s = document.getElementsByTagName('script')[0];
                                s.parentNode.insertBefore(gcse, s);
                              })();
                            </script>
                            <gcse:searchbox-only></gcse:searchbox-only>
                        </section>
                        <section>
                            <h3>Contact me</h3>
                            <ul>
                                <li>Email me at chartjes@grumpy-learning.com</li>
                                <li>Find me on Twitter as <a href="https://twitter.com/grmpyprogrammer">@grmpyprogrammer</a></li>
                            </ul>
                        </section>
			<section>
				<h3>Sponsor me</h3>
				<p>If you like the work I do on <a href="https://github.com/opencfp/opencfp/">OpenCFP</a> you can become a
				sponsor via my <a href="https://github.com/sponsors/chartjes">GitHub sponsors</a> page. Your sponsorship
				allows me to spend more time on open source and less time writing books and training material.</p>
			</section>
                        <section>
                            <h3>Books</h3>
                            <ul>
				<li><a href="https://leanpub.com/grumpy-guide">The Grumpy Programmer's Guide To Testing PHP Applications (currently pre-ordering)</a></li>
                                <li><a href="https://leanpub.com/test-driven">Building Test-Driven Developers</a></li>
                                <li><a href="https://leanpub.com/minimumviabletests">Minimum Viable Tests</a></li>
                                <li><a href="https://leanpub.com/grumpy-phpunit">The Grumpy Programmer's PHPUnit Cookbook</a></li>
                            </ul>
                        </section>
                    </div>
                </div>
            </div>
        </div>
        <footer class="container">
            &copy; 2020 @TheKeyboard
        </footer>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="/components/jquery/jquery.min.js"><\/script>')</script>
        <script src="/components/bootstrap/js/bootstrap.min.js"></script>
                
                <script src="/components/highlightjs/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
