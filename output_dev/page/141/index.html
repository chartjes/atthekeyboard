<!DOCTYPE html>
<html>
    <head>
        <title>Home &mdash; @TheKeyboard &mdash; The ramblings of a grumpy programmer</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="/components/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="/components/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
        <link href="/css/style.css" rel="stylesheet" type="text/css" />
        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
            <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <link rel="stylesheet" href="/components/highlightjs/styles/github.css" />
        <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="@TheKeyboard activity feed" />
        <style>
        /** quick fix because bootstrap <pre> has a background-color. */
        pre code { background-color: inherit; }
        </style>
    </head>
    <body>
        <header>
            <div class="navbar navbar-inverse navbar-fixed-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="/">@TheKeyboard</a>
                        <div class="nav-collapse collapse">
                            <ul class="nav">
                                <li><a href="/blog">Posts Archive</a></li>
                                <li><a href="/blog/categories">Categories</a></li>
                                <li><a href="/blog/tags">Tags</a></li>
                                <li><a href="/about">About</a></li>
                            </ul>
                        </div><!--/.nav-collapse -->
                    </div>
                </div>
            </div>
        </header>
        <div class="mainContent container">
            <div class="row-fluid">
                <div class="span8">
                        <article>
        <header>
            <h2><a href="/blog/2014/10/31/web-acceptance-tools-suck">Web Acceptance Tools Suck</a></h2>
        </header>
        <div>
            <p>Wow. Almost a whole year since I posted something. Time to change that.</p>

<p>It is not a coincidence that I write this blog post on Halloween 2014. Because
I want to talk about something that should make your skin crawl and want to 
turn all the lights on in the location where you are reading this.</p>

<p>I am talking, of course, about writing automated web acceptance tests.</p>

<p>At ZendCon2014 I did a talk about how to use <a href="http://behat.org">Behat</a> and
<a href="http://mink.behat.org">Mink</a> to write some automated acceptance tests for
your web sites. You know, the type of thing where you drive a browser using
some code and it pretends to click on things...and you lie to yourself about
what value all this work is giving you.</p>

<p>I also made the classic mistake of waiting too long to go over my slides for
this talk and realized I was using versions of these tools that were extremely
out of date. I then spent 6 hours updating the code, instead of watching my
friends give awesome talks about PHP and complementary technologies.</p>

<p>This sucked. Sucked big time.</p>

<p>As far as I can tell, we are currently at the point in the PHP community with 
these tools like unit testing tools were 10 years ago when I first decided I
needed to find ways to never work 120 hours of overtime in 6 weeks leading
up to Christmas ever again.</p>

<p>Behat and Mink are both very powerful tools, but their documentation is
lacking and the code samples review what I think is a very large disconnect
between how the creators of these tools use them and how the rest of us use
them. I have no idea if there is even any blame to be handed out, unless you
subscribe to the theory that shitty documentation is the fault of the people
who created the projects in question.</p>

<p>I am not diminishing the work of those who created these things. They are
great programmers, and I am just a grumpy guy who wants things to work a
certain way and not act like obstacles. I like my tools to be complementary
and easy to figure out how to bend to my will.</p>

<p>But when I look at how brittle these things are, and how slow they are, it
makes me wonder if I wasted my time learning how to use them.</p>

<p>For those who don't understand what I am getting at, or think I am acting like
the drama queen they secretly hope I am, consider this -- the best way to
identify elements on a web page is to use tools that expect you to either
fully understand CSS and also how XPath works.</p>

<p>Folks, this is a shit show.</p>

<p>Now, it is entirely possible I am simply Doing It Wrong, and will be happy
to be corrected. Take a look at the code in <a href="https://github.com/chartjes/wat-zendcon14">this repo</a>
AND DESPAIR. This code is brittle, has to maintain state between test steps
manually, and the tests take forever to run because you have the overhead
of starting up a browser and painfully crawling through the DOM to find things.</p>

<p>(By the way, who is the person that decided the DOM was the best way to internally
represent elements on a web page? If it was Tim Berners-Lee, well, it strikes me
as a decision that is biting us in the ass now but was probably totally logical
at the time)</p>

<p>I am hopeful that someone out there is working on a better set of abstractions
and tools that will make the types of things we are asking Behat and Mink and
Page Objects and PhantomJS to do a lot better.</p>

<p>Send me your thoughts and ideas on Twitter or to chartjes@grumpy-learning.com
and I will do a follow-up post.</p>

        </div>
            </article>
    <article>
        <header>
            <h2><a href="/blog/2013/12/27/test-spies-and-mockery">Test Spies and Mockery</a></h2>
        </header>
        <div>
            <p>While recording some screencasts I was struggling to figure out how to
get PHPUnit's built-in object mocking tools to allow me to create what is
known as a "test spy". I talk about them briefly in my <a href="http://grumpy-phpunit.com">PHPUnit Cookbook</a>
but I think that what I wanted to do in this instance was beyond what PHPUnit
could give me.</p>

<p>I had some code-under-test that had a conditional statement inside a foreach()
loop (aggravating my desire to use <a href="http://www.slideshare.net/rdohms/bettercode-phpbenelux212alternate">object calisthenics</a>)
and I wanted to make sure that both branches of the conditional statement got
executed.</p>

<p>I first tried something like this:</p>

<pre><code>    // $db is our mocked database object based off stdClass for testing
    $db-&gt;expects($this-&gt;once())
        -&gt;method('query')
        -&gt;with($update, ['id' =&gt; 1]);
    $db-&gt;expects($this-&gt;once())
        -&gt;method('query')
        -&gt;with($delete, ['id' =&gt; 5]);
</code></pre>

<p>I was using <a href="http://auraphp.com/manuals/v1/en/sql/">Aura.Sql</a> and it's Update
and Delete objects. I wanted to be sure that I was using both objects.</p>

<p>I also tried using <em>$this->at(0)</em> and <em>$this->at(1)</em> as well, I got errors
ranging from "method query was not mocked" to problems complaining about
expected values not showing up at the expected sequence.</p>

<p>I knew there had to be a better way, but I really wanted just to use PHPUnit's
built-in mocking. I couldn't figure it out. So instead I turned to a mocking
library that I knew supported test spies: <a href="https://github.com/padraic/mockery">Mockery</a>.</p>

<p>The code reads a lot smoother:</p>

<pre><code>    // m is an alias to \Mockery
    $db = m::mock('stdClass');
    $db-&gt;shouldReceive('query')-&gt;with($update, ['id' =&gt; 1])-&gt;once();
    $db-&gt;shouldReceive('query')-&gt;with($delete, ['id' =&gt; 5])-&gt;once();
</code></pre>

<p>The first thing that jumps out at me is that the Mockery version looks cleaner.
Well, really, it's only one less chained call. But looks do count for something.</p>

<p>More importantly, my test worked the first time with no weird error messaging
about unexpected behaviour.</p>

<p>So the next time you are writing a unit test and need to create spies on
methods of a mocked object, I cannot recommend enough that you take a look
at Mockery.</p>

        </div>
            </article>
    <article>
        <header>
            <h2><a href="/blog/2013/11/18/the-power-of-the-browserproxymob">The Power of the BrowserProxyMob</a></h2>
        </header>
        <div>
            <p>At <a href="http://synacor.com">work</a> I have been involved with an effort to put some
automated front-end testing in place. The combination of <a href="http://behat.org">Behat</a>,
<a href="http://mink.behat.org">Mink</a> running tests using <a href="http://phantomjs.org">PhantomJS</a>
is a good one for this. Open source, easy to configure, handles JavaScript-heavy
pages reasonably well.</p>

<p>There was just one wrinkle in our plans: our use of local host files.</p>

<p>Somewhere back in the mists of time it was decided that in order to properly
test our web applications without pummelling our production assets (like
image farms, content servers, API end points) that a "hostfile generator"
would be created and is accessible on every machine in our development VM
network.</p>

<p>You hit <hostname>/hosts and it spits out a file that you can use on your
laptop to alias production assets / resources / whatever to things on your
development server. I use a program on my MacBook called <a href="http://www.clockwise.ee/gasmask/">Gas Mask</a>
that lets me quicky switch between host files when testing out sites on
various development boxes. I am sure a similar tool exists for Windows and
Linux users.</p>

<p>So, initially the only way to make Behat play nicely with the host files was
to manually over-write the /etc/hosts file on the development server with
the host-specific one the generator gives us. That way all the host aliases
in place.</p>

<p>This is fine and all, but I am pretty sure our sysadmins would never allow
the user that runs our continuous integration jobs have the proper permissions
to  overwrite the host files. If a test run were to crash and generate fatal
errors, we would end up with a machine with a bad host file in place.</p>

<p>So clearly what was needed was a proxy. After doing a little bit of digging
around I found a solution: <a href="http://bmp.lightbody.net/">BrowserMobProxy</a>. While
it bills itself as a tool for helping web developers "watch and manipulate
network traffic from their AJAX applications" it also has a feature that
is of great interest to our problem: it supports the ability to create aliases
to hosts...oddly enough just like we do with our host files at work.</p>

<p>So, BrowserMobProxy is great in that you can send requests to REST-style but
I didn't want to mess around with manual calls, so I was happy to find that
my friend <a href="http://element34.ca">Adam Goucher</a> had written a PHP library for
interacting with it. I forked his code, cleaned it up a little and it's
now available via <a href="https://packagist.org/packages/chartjes/php-browsermob-proxy">Packagist</a>
and ready to install via <a href="http://getcomposer.org">Composer</a>.</p>

<p>So, let's get started with what I did.</p>

<p>Here's my composer.json file for the project</p>

<pre><code>{
    "require": {
        "behat/behat": "2.4.*@stable",
        "behat/mink": "1.4@stable",
        "behat/mink-extension": "*",
        "behat/mink-goutte-driver": "*",
        "behat/mink-selenium2-driver": "*",
        "chartjes/php-browsermob-proxy" "dev-master",
        "sauce/connect": "&gt;=3.0",
        "sauce/sasuage": "&gt;=0.5",
    },
    "config": {
        "bin-dir": "bin/"
    }
}
</code></pre>

<p>We are experimenting with using <a href="http://sauce.io">SauceLabs</a> for testing our
sites on mobile devices (in case you were wondering).</p>

<p>With that stuff installed, I next downloaded a copy of BrowserMobProxy (herafter referred to as BMP) and
copied the CLI runner and JAR files into the 'bin' directory. Next, I installed
PhantomJS in /usr/local/bin on my server.</p>

<p>Next, we setup our Behat configuration file to point to PhantomJS when doing
our tests using Selenium2's web driver capabilities:</p>

<pre><code>phantomjs:
    context:
        class: "FeatureContext"
    extensions:
        Behat\MinkExtension\Extension:
            default_session: selenium2
            javascript_session: 'selenium2'
            base_url: http://synacor.com
            selenium2:
                wd_host: http://127.0.0.1:4444/wd/hub
</code></pre>

<p>Now, we get to the tricky part.</p>

<p>BMP requires you to connect to it first to get it to start a
proxy connection running on a <em>different</em> port than the one the main service
runs on. In my Behat test runner script I use the PHP BMP library to create
a connection, and it assigns it to the first available port in a range you
can specify at run time.</p>

<p>Because I can count on this value to be the same all the time, I then start
up an instance of PhantomJS telling it to run in "accept requests like I am
WebDriver compatible" proxy all requests through BMP</p>

<pre><code>/usr/local/bin/phantomjs --webdriver=4444 --proxy=http://localhost:9091
</code></pre>

<p>In my Behat context class I add in a step that reads in the host file via
our host file generator and assigns the host aliases to BMP so that when
Behat uses PhantomJS to load web pages, it will use the host aliases set
within BMP.</p>

<p>I know that it's pretty convoluted, but I know with 100% certainty that it
works.</p>

<p>If you spot anything here that doesn't make sense, let me know and I will
update the post.</p>

        </div>
            </article>
    <nav>
        <a href="/page/140">Newer Posts</a><br />
        <a href="/page/142">Older Posts</a><br />
    </nav>
                </div>
                <div class="span4 sidebar">
                    <div class="well">
                        <h4>@TheKeyboard <small>The ramblings of a grumpy programmer</small></h4>
                    </div>
                    <div class="well sidebar-nav">
                        <h4>Links</h4>
                        <ul class="nav">
                            <li><a href="http://sculpin.io">sculpin.io</a></li>
                            <li><a href="http://twitter.com/getsculpin">@getsculpin</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <footer class="container">
            &copy; 2014 @TheKeyboard
        </footer>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="/components/jquery/jquery.min.js"><\/script>')</script>
        <script src="/components/bootstrap/js/bootstrap.min.js"></script>
                
                <script src="/components/highlightjs/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
