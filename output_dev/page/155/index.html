<!DOCTYPE html>
<html>
    <head>
        <title>Home &mdash; @TheKeyboard &mdash; The ramblings of a grumpy programmer</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="/components/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="/components/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
        <link href="/css/style.css" rel="stylesheet" type="text/css" />
        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
            <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <link rel="stylesheet" href="/components/highlightjs/styles/github.css" />
        <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="@TheKeyboard activity feed" />
        <style>
        /** quick fix because bootstrap <pre> has a background-color. */
        pre code { background-color: inherit; }
        </style>
    </head>
    <body>
        <header>
            <div class="navbar navbar-inverse navbar-fixed-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="/">@TheKeyboard</a>
                        <div class="nav-collapse collapse">
                            <ul class="nav">
                                <li><a href="/blog">Posts Archive</a></li>
                                <li><a href="/blog/categories">Categories</a></li>
                                <li><a href="/blog/tags">Tags</a></li>
                                <li><a href="/about">About</a></li>
                            </ul>
                        </div><!--/.nav-collapse -->
                    </div>
                </div>
            </div>
        </header>
        <div class="mainContent container">
            <div class="row-fluid">
                <div class="span8">
                        <article>
        <header>
            <h2><a href="/blog/2011/12/05/war-room-driven-deployment">War-room Driven Deployment</a></h2>
        </header>
        <div>
            <p>For a long time I have been an advocate of the philosophy that organizations
as a whole, not just the engineering team (if there is such a thing where
you work) should be striving towards the goal of treating any deployment
of your code into production as a non-event. Sadly, there is much work to be
done from both ends of the spectrum.</p>

<p>When deployments do go wrong the reaction is fairly predictable. It's almost 
like the five stages of grief, sometimes known as the Kuebler-Ross model. 
You've probably heard about them: Denial, Anger, Bargaining, Depression, 
and Acceptance.</p>

<p>The common thing that happens during those two first stages is that people are 
chewed out for their role in the deployment failure, and in many cases the anger
is legitimate. If you haven't written code that spectacularly failed in a 
production environment I will happily call you a liar.</p>

<p>What also then happens is that the non-technical people push for what I call a
war-room environment for dealing with deployments. By this I mean that, for
lack of a better phrase, orders come down from on-high that whenever a 
production push is going to be done that everyone needs to stick around and be
there "just in case" something goes wrong.</p>

<p>At the news of the new directive, the engineering staff roll their eyes and
mumble to each other about how the other side "doesn't get it" and how "this
won't solve these problems".</p>

<p>Both sides are right, but only up to a point.</p>

<p>I'm sure that some of my readers are familiar with the concept of perception
vs. reality. When you apply this to deployment failures, the perception
becomes that the entire team responsible for building the application
is to blame and that by making sure that everyone should be there it fixes
the problem. In my opinion, the reality is that the failure occurred due to 
the actions of one or two individuals and making the whole team suffer is 
counterproductive. I feel this way especially when I am directly responsible
for what has happened.</p>

<p>Finding bugs in development are magnitudes cheaper to fix than production ones,
and you will feel less pressure to fix them than if they are discovered in
production. To paraphrase Darth Vader, you know in your heart that this true.
Therefore the engineering side of the equation really needs to push back hard
on the idea that ALL HANDS ON DECK WE ARE DEPLOYING is not just making the
problem worse before it can get better.</p>

<p>I've had my fair share of time with war-room driven deployment. I understand
why it is viewed as a solution to the problem of failed deployments. It seems
very logical. By having everyone there when it happens you are more likely
to be able to quickly solve any problems you find. However, I feel like it is
masking the true problem in that everything that you find yourself doing when
practicing war-room driven deployment can be done before you even get to that 
point.</p>

<p>It also becomes an issue of trust. Frequent failed deployments results in the
engineering side of things to be labeled as sloppy, uncaring, not understanding
the cost of lost opportunities. All of those things may or may not be clear, but
I think forcing everyone to stick around "just in case" makes the situation worse.</p>

<p>By using war-room driven deployment you are making all stakeholders nervous about
deployments. Everyone will be exhorted to think of everything that could go wrong
with the deployment and if something does go wrong, the stress level gets cranked
up to 11 and there is frantic activity to try and solve the problem.</p>

<p>It is often hard to explain to non-technical people that they should stay calm
and understand that the engineering team knows what went wrong and has a real-world
solution in mind to fix whatever problem happened to minimize the chances that
it happens again in the future. I don't have any easy answers on how to solve
that problem other than staying calm yourself and offering real-world, practical
solutions to the problems.</p>

<p>If you put all the effort into making production pushes a non-event, then you will
not need war-room driven deployment. All you need is one person to push a button
and then everyone can go home.</p>

        </div>
            </article>
    <article>
        <header>
            <h2><a href="/blog/2011/11/25/scope-is-not-mouthwash">Scope is not a mouthwash</a></h2>
        </header>
        <div>
            <p>One of the worst-kept secrets now is that I have started working on a book
about some practical techniques for building testable applications. I'd
say I'm about half done, and the book will be ready for sale
when I give my talk at <a href="http://codemash.org">CodeMash 2012</a> on the same topic.</p>

<p>Why do I care about all this stuff that causes friction for programmers?
Because there is so much I want to learn and fragile, untestable applications
get in the way of me becoming the programmer I want to be. Naturally I am also
working on an application that will serve as a companion to the book, a hand-crafted
web application that will embody the techniques I describe in the book. It is also
very humbling to "eat your own dogfood", meaning build you applications using
the practices you are espousing.</p>

<p>So, I set out to show people in my chapter of the book about decoupling objects
via the magic of dependency injection how to use this awesome thing known as a
dependency injection container. Although they are more suited for very large
complex applications like web application frameworks but I thought "I could
see someone like a younger version of me wanting to mess around with something
like this even though it might be totally inappropriate for the application.
Let's do it!"</p>

<p>For this I am using <a href="http://pimple.sensiolabs.org">Pimple</a>, an incredibly small
but effective dependency injection container. Easy to use, simple and effective
documentation, just what I was looking for. I also noticed that Pimple supported
the use of closures (or anonymous functions) as a way of storing a dependency.</p>

<p>Then things got stupid.</p>

<p>I altered the bootstrap file for my application (it's using the <a href="http://toys.lerdorf.com/archives/38-The-no-framework-PHP-MVC-framework.html">no-framework framework approach</a>) and set up an instance of Pimple and wrote this cool-looking code that stores
a mapper for one of my models in it:</p>

<pre><code>$container = new \Pimple();
$container['db_connection'] = function ($c) {
    return new PDO(
        'pgsql:host=localhost;dbname=ibl_stats', 
        'login',
        'pass'
    );
};
$container['franchise_mapper'] = function ($c) {
    return new IBL\FranchiseMapper($c['db_connection']);
};
</code></pre>

<p>What you don't see in this snippet is that before this happens, I am using a PSR-0
compliant autoloader. Go Google for it, it's hard to explain in a few short words
and I am also using namespaces to show people just how easy they are to use. I 
love autoloading. Spares me dealing with 'require&#95;once' and 'include&#95;once' and also worrying
about if I've required or included a file somewhere else.</p>

<p>I reload my test page and...what the hell? "Cannot find class IBL\FranchiseMapper"</p>

<p>That...that...that cannot be! It's RIGHT THERE! I have unit tests that run just fine
and the autoloader grabs it there too!</p>

<p>So I start asking for help on Twitter. "It must be Pimple causing the problem." Pimple's
creator <a href="https://twitter.com/#!/fabpot/status/139706391777648640">smacks me down</a> and
I look at the code and say "of course it can't be Pimple. Keep looking!"</p>

<p>Next I figure there is something specific to closures that is causing the problem. I reach
out for more help, trying things willy-nilly to try and figure it out. I contemplate using
Xdebug to trace what is going on in the autoloader. Not very easy to debug autoloaders. 
Finally I see something (of course I cannot find the link now) that talks about closures
and scope. That is when I realize how fucking stupid I have been.</p>

<p>So, let's talk about scope for a second. Besides being the brand name for a mouthwash, scope
is a topic that some programmers get tripped up on. Despite my 14 years of PHP experience I often
feel like it is 1 year repeated 14 times. Scope deals with variables (and in this case namespaces)
and where they can be accessed from.</p>

<p>You have global scope, meaning that the variable/object/function can be accessed from anywhere.
Then you have the scope of something inside a standalone function. Unless (mind you, this is PHP
and I cannot speak for other languages) you mark it as global, it can only be accessed from 
inside that function. Now, you can declare a variable/object/whatever as being accessible inside
that object via the use of (for example) $this->foo but that variable, and you can also slap
public/protected/private to decide who can see it when you interact with that object.</p>

<p>To roll back to me, my problem was not one of variable scope. It was one of namespace scope. With
the introduction of namespaces to PHP you now have the concept of the "global namespace", which is
where all the existing PHP functions and objects live. If you want to be pedantic (and Wotan knows
I sometimes enjoy pedant status) you should be prefixing all your calls to things like 
mysql&#95;query() with a backslash. Try it out and see if I'm telling the truth.</p>

<p>So I'm scratching my head looking at this code. "What the hell, dude. I've got nothing to lose
by adding a backslash in front of IBL." Of course it worked. But why did it work?</p>

<p>(Grumpy developer's note: I was asked on Twitter to expand a bit on the reasons behind why
things work this way. I am not a PHP internals guy so everything I say here is
just an educated guess)</p>

<p>With the introduction of namespaces, PHP has to operate under some assumptions. If
you are going to remain backwards-compatible with a lot of code and support namespaces
then you have to make some rules too. As far as I can tell, when PHP encounters an object
or function, it assumes that it is in the global namespace first. This is how you can do
things like $query = mysql&#95;query() and have it not complain. No prepended backslash, it
assumes it is in the global namespace.</p>

<p>Now, let's say I am trying to do this:</p>

<pre><code>$mapper = new IBL\FranchiseMapper($container['db\_connection']);
</code></pre>

<p>There is no pre-pended backslash but there <em>is</em> a backslash after the IBL, therefore PHP can
assume that there are namespaces involved. Then (I think) it goes and looks to see if
there is currently an 'IBL' namespace that it has been asked to use. Because of the autoloader
it is aware of that namespace, so then it happily loads it.</p>

<p>So why does it behave differently inside closures? I am not 100% sure, but if I had to
make an educated guess I would say that when trying to resolve namespaces inside
a closure, the interpretor doesn't assume that it is already inside the global namespace,
that it is in a namespace of it's own. Hence the need to explicitly declare that you
are starting with the global namespace (prepending the backslash) and then working
your way down.</p>

<p>If any PHP interals contributors read this blog post I would appreciate a follow-up 
comment to confirm and/or explain how this works.</p>

<p>So, it looks like closures are stricter and was reminding me, via that error message, 
that I need to be aware
of the current scope of the namespace (is that even the right way to put it?) 
and prepend that backslash so my autoloader (which is hooked into spl&#95;autoload&#95;register)
can, you know, find and create that object for me. So here's how it looks now</p>

<pre><code>$container = new \Pimple();
$container['db_connection'] = function ($c) {
    return new \PDO(
        'pgsql:host=localhost;dbname=ibl_stats', 
        'login',
        'pass' 
    );
};
$container['franchise_mapper'] = function ($c) {
    return new \IBL\FranchiseMapper($c['db_connection']);
};

$mapper = $container['franchise_mapper'];
</code></pre>

<p>Yay! I can create a mapper via the dependency injection container.</p>

<p>I know that a lot of beginning to intermediate javascript programmers &#42;cough&#42;me&#42;cough&#42; have
to pay attention to variable/function/object scope issues as well. Also, don't be like me when
there are no tests for your code and start randomly changing things in hopes that it works.</p>

<p>It usually doesn't.</p>

        </div>
            </article>
    <article>
        <header>
            <h2><a href="/blog/2011/11/07/building-a-gimmebar-sidebar">Building a Gimmebar Sidebar</a></h2>
        </header>
        <div>
            <p>One of the interesting side effects of getting involved in your programming
language community of choice is that you often get access to cool projects
being done by your community buddies before the rest of the riffraff (aka 
the general public). One such project is <a href="http://gimmebar.com">Gimme Bar</a>,
a "capture anything you want and read later" web site. Created by the fine
folks at <a href="http://fictivekin.com/">Fictive Kin</a>, <a href="http://twitter.com/coates">Sean Coates</a>
and <a href="http://twitter.com/funkatron">Ed Finkler</a> were kind enough to not only
give me access to their application (My user type apparantly is "The Betanaut") but
also an early peek at their API.</p>

<p>Now, it's changed a bit since their earliest work but now they are starting to promote
not only the site but showing how easy it is to use their API to play around with
not only your content but other's public-facing content too. I fooled around with
the API and tried to write some Python stuff but lots patience when trying to work
with OAuth from the command line. Hey, it's not their fault that I couldn't be bothered
to slog through it all.</p>

<p>Funkatron was kind enough to put together a blog post about <a href="http://funkatron.com/posts/building-a-tumblelog-with-gimme-bar-and-php.html">building a Tumblelog with 
Gimmer Bar and PHP</a>
so I told him I would write up what I did on my own blog.</p>

<p>One of my intents was to use the <a href="https://gimmebar.com/api/v0">Gimme Bar API</a> to pull
in a list of my latest Gimmies for the sidebar on this blog. Ed had posted a very
simple example in Javascript (I cannot remember where it is) so I took it and ran with
it to modify it to work with <a href="http://octopress.org">the blogging software</a> used here.</p>

<p>I went and asked some questions in the Freenode IRC channel for Octopress and found out
that they recommended the use of JS libraries that are compatible with <a href="http://dustindiaz.com/ender">Ender.js</a>.
Okay, so that was no problem. So what to use to make the actual AJAX request call to
the API? <a href="https://github.com/ded/reqwest">Reqwest</a> was mentioned by some as the best
fit for using with Ender. Reqwest is an easy-to-use JS AJAX library that the #octopress
guys suggest I use since jQuery doesn't currently play nice with all the other JS
libraries that Octopress is using.</p>

<p>Finally, I used <a href="https://github.com/documentcloud/underscore">Underscore</a> to 
help with templating.</p>

<p>Even though I'm not much of a JS whiz, I was able to take Ed's example and very quickly
modify it to work exactly the way I wanted it to. Below is the code I used to putt in 
my 10 latest Gimmes and insert them into the DOM exactly where I wanted them.</p>

<pre><code>&lt;section&gt;
  &lt;h1&gt;My Latest Gimmies&lt;/h1&gt;
  &lt;ul id="gb_assets"&gt;&lt;/ul&gt;
  &lt;script type="text/javascript"&gt;
  reqwest({
      url: 'https://gimmebar.com/api/v0/public/assets/grumpycanuck.js?jsonp_callback=?',
      type: 'jsonp',
      success: function(data){
          var list_tpl = "&lt;% _.each(records, function(record) { %&gt; &lt;li&gt;&lt;a href='https://gimmebar.com/view/&lt;%=record.id%&gt;'&gt;&lt;%=record.title%&gt;&lt;/li&gt;&lt;/a&gt; &lt;% }); %&gt;";
          var list_html = _.template(list_tpl, data);
          $('#gb_assets').html(list_html);
      }
  });
  &lt;/script&gt;                                                                                                                                                     
&lt;/section&gt;
</code></pre>

<p>For those who aren't JS-savvy, I'll explain what goes on here:</p>

<ul>
    <li>Execute an AJAX call that...</li>
    <li>calls the Gimme Bar public API to get the latest 10 public posts...</li>
    <li>and on success generate an unordered list of posts...</li>
    <li>linking to the item on Gimme Bar and show the title...</li>
    <li>and insert it into the DOM where I asked it to</li>
</ul>

<p>Easy peasy, lemon squeezy. Ender.js + Reqwest + Underscore + 15 lines of markup and JS
gives me the latest 10 posts. Hope this inspires you to play with the Gimme Bar API
yourself.</p>

        </div>
            </article>
    <nav>
        <a href="/page/154">Newer Posts</a><br />
        <a href="/page/156">Older Posts</a><br />
    </nav>
                </div>
                <div class="span4 sidebar">
                    <div class="well">
                        <h4>@TheKeyboard <small>The ramblings of a grumpy programmer</small></h4>
                    </div>
                    <div class="well sidebar-nav">
                        <h4>Links</h4>
                        <ul class="nav">
                            <li><a href="http://sculpin.io">sculpin.io</a></li>
                            <li><a href="http://twitter.com/getsculpin">@getsculpin</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <footer class="container">
            &copy; 2014 @TheKeyboard
        </footer>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="/components/jquery/jquery.min.js"><\/script>')</script>
        <script src="/components/bootstrap/js/bootstrap.min.js"></script>
                
                <script src="/components/highlightjs/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
