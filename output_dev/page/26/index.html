<!DOCTYPE html>
<html>
    <head>
        <title>Home &mdash; @TheKeyboard &mdash; The ramblings of a grumpy programmer</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="/components/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="/components/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
        <link href="/css/style.css" rel="stylesheet" type="text/css" />
        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
            <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <link rel="stylesheet" href="/components/highlightjs/styles/github.css" />
        <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="@TheKeyboard activity feed" />
        <style>
        /** quick fix because bootstrap <pre> has a background-color. */
        pre code { background-color: inherit; }
        </style>
    </head>
    <body>
        <header>
            <div class="navbar navbar-inverse navbar-fixed-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="/">@TheKeyboard</a>
                        <div class="nav-collapse collapse">
                            <ul class="nav">
                                <li><a href="/blog">Posts Archive</a></li>
                                <li><a href="/blog/categories">Categories</a></li>
                                <li><a href="/blog/tags">Tags</a></li>
                                <li><a href="/about">About</a></li>
                            </ul>
                        </div><!--/.nav-collapse -->
                    </div>
                </div>
            </div>
        </header>
        <div class="mainContent container">
            <div class="row-fluid">
                <div class="span8">
                        <article>
        <header>
            <h2><a href="/_posts/2006-08-09-socket-servers.markdown"></a></h2>
        </header>
        <div>
            <hr />

<p>layout: post
title: Socket Servers</p>

<h2>author: Chris Hartjes</h2>

<p>A lot of programmers who work with PHP don't even know that you can create shell scripts that run in PHP.  I've used them to pull data from remote servers as part of a work project and are also doing fun things with creating a PHP daemon that runs in the background listening to TCP/IP requests on a specifc port.</p>

<p>Why? I'm writing code that will have to parse the output of a Java client that connects to the <a href=http://www.pa-sportsticker.com/en/index.html>SportsTicker</a> service.  We have plans to create a Flash applet that goes on our forum sites that will present the SportsTicker info in various formats.  SportsTicker spits out XML (which PHP 5 is very good at managing) so my listener simply buffers all the data that comes in and then spits out the XML data to a file that another script will most likely read and modify the info.  I know that Flash can apparantly read in XML data, but who knows if the guy who will be building the Flash component actually knows how to do it.</p>

<p>Here's a sample of the code I've been working on (not the final version obviously) based on a cool tutorial on the Zend site called <a href=http://www.zend.com/pecl/tutorials/sockets/php>Writing Socket Servers in PHP</a>.</p>

<pre><code><br />#!/usr/bin/php
&lt;?php

/**
 * PHP script that acts as a listener for the output from the Java Sportsticker Client
 *
 * @author Chris Hartjes
 */

set_time_limit(0);

$address = '127.0.0.1';
$port = 9600;
$max_clients = 10;
$clients = Array();
$read = Array();
$buffer = "";
$sock = socket_create(AF_INET, SOCK_STREAM, 0);
socket_bind($sock, $address, $port) or die('Could not bind to address');
socket_listen($sock);

while (TRUE) {
    $read[0] = $sock;

    for ($i = 0; $i&lt; $max_clients; $i++) {
        if (isset($client[$i]['sock']) &amp;&amp; $client[$i]['sock'] != NULL) {
            $read[$i + 1] = $client[$i]['sock'];
        }
    }

    $ready = socket_select($read, $write = NULL, $except = NULL, NULL);

    if (in_array($sock, $read)) {

        for ($i = 0; $i &lt; $max_clients; $i++) {

            if (!isset($client[$i]['sock'])) {
                $client[$i]['sock'] = socket_accept($sock);
                break;
            } else if ($i == $max_clients - 1) {
                print "Too many clients";
            }
        }

        if (--$ready &lt;= 0) {
            continue;
        }
    }

    for ($i = 0; $i &lt; $max_clients; $i++) {

        if (isset($client[$i]['sock']) &amp;&amp; in_array($client[$i]['sock'], $read)) {
            $input = socket_read($client[$i]['sock'], 1024);

            if ($input == NULL) {
                unset($client[$i]);
            }

            $input = trim($input);

            // Now, we add info to the buffer
            $buffer .= $input;

            // Write the data to a file if we have a closing XML tag
            if (stristr($buffer, '&lt;/xml&gt;')) {
                echo $buffer;
                $buffer = "";
            }

        } else {
            if (isset($client[$i]['sock'])) {
                socket_close($client[$i]['sock']);
                unset($client[$i]);
            }
        }
    }
}

socket_close($sock);
?&gt;

</code></pre>

<p>In just about 80 lines you have a working server that listens for requests on a specific port and spits out the data when it thinks you've reached the end.  Once I get a better handle on the actual info coming from SportsTicker (the server that is supposed to run the Java client is having some Java configuration issues that one of our admins is fixing as I type this) then I'm sure I'll put in some error handling and other exceptions.</p>

<p>I'm not entirely happy with the for loop being used to go through all the connections so perhaps I'll spend some time trying to fix it.  If it turns out that I never have more than one connection at a time then I can probably elminate that loop totally, creating some tighter code.  It's never too early to refactor stuff. :)</p>

        </div>
            </article>
    <article>
        <header>
            <h2><a href="/_posts/2006-08-10-theballpark-is-broken.markdown"></a></h2>
        </header>
        <div>
            <hr />

<p>layout: post</p>

<h2>title: "@TheBallPark is broken"</h2>

<p>Yes, I'm aware that my other blog is broken.  Trying to resolve an issue with an upgrade gone horribly wrong. :)</p>

        </div>
            </article>
    <article>
        <header>
            <h2><a href="/_posts/2006-08-12-all-quiet.markdown"></a></h2>
        </header>
        <div>
            <hr />

<p>layout: post</p>

<h2>title: All Quiet...</h2>

<p>Got @TheBallPark back up and running (and managed to save all the old posts too).  Phew.  Too tired to blog, I'll post something tomorrow...</p>

        </div>
            </article>
    <nav>
        <a href="/page/25">Newer Posts</a><br />
        <a href="/page/27">Older Posts</a><br />
    </nav>
                </div>
                <div class="span4 sidebar">
                    <div class="well">
                        <h4>@TheKeyboard <small>The ramblings of a grumpy programmer</small></h4>
                    </div>
                    <div class="well sidebar-nav">
                        <h4>Links</h4>
                        <ul class="nav">
                            <li><a href="http://sculpin.io">sculpin.io</a></li>
                            <li><a href="http://twitter.com/getsculpin">@getsculpin</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <footer class="container">
            &copy; 2014 @TheKeyboard
        </footer>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="/components/jquery/jquery.min.js"><\/script>')</script>
        <script src="/components/bootstrap/js/bootstrap.min.js"></script>
                
                <script src="/components/highlightjs/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
