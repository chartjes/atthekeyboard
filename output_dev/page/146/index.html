<!DOCTYPE html>
<html>
    <head>
        <title>Home &mdash; @TheKeyboard &mdash; The ramblings of a grumpy programmer</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="/components/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="/components/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
        <link href="/css/style.css" rel="stylesheet" type="text/css" />
        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
            <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <link rel="stylesheet" href="/components/highlightjs/styles/github.css" />
        <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="@TheKeyboard activity feed" />
        <style>
        /** quick fix because bootstrap <pre> has a background-color. */
        pre code { background-color: inherit; }
        </style>
    </head>
    <body>
        <header>
            <div class="navbar navbar-inverse navbar-fixed-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="/">@TheKeyboard</a>
                        <div class="nav-collapse collapse">
                            <ul class="nav">
                                <li><a href="/blog">Posts Archive</a></li>
                                <li><a href="/blog/categories">Categories</a></li>
                                <li><a href="/blog/tags">Tags</a></li>
                                <li><a href="/about">About</a></li>
                            </ul>
                        </div><!--/.nav-collapse -->
                    </div>
                </div>
            </div>
        </header>
        <div class="mainContent container">
            <div class="row-fluid">
                <div class="span8">
                        <article>
        <header>
            <h2><a href="/blog/2012/10/15/first-steps-in-node-testing">First steps in Node testing</a></h2>
        </header>
        <div>
            <p>As I've been promising, I wanted to share my thoughts as I am starting to
brush up on my JavaScript and learn how to do something non-trivial with
<a href="http://nodejs.org">Node.js</a>. Of course, I want to use tests to
help me drive my work, and also as a way to keep me focused on small iterations
of work.</p>

<p>I am intending to write some code to act as an API for the <a href="http://www.ibl.org">site that runs my simulation baseball league</a>
and refactor the existing PHP code to consume that API instead of speaking
to the database through CakePHP (really OLD CakePHP at that too) models.</p>

<p>So, it took me a while to search around and find enough information to create
my first integration test. In the end, the stack is <a href="http://visionmedia.github.com/mocha/">Mocha</a>
to do the testing, with <a href="https://github.com/visionmedia/supertest">SuperTest</a> to handle
all the HTTP testing.</p>

<p>So, the app itself is built on <a href="http://expressjs.com/">Express</a> and 
talking to a Postgres database using <a href="https://github.com/brianc/node-postgres">node-postgres</a>.
It seemed to me that express was the best solution for a newcomer to Node but
familiar with MVC / modern web application paradigms.</p>

<p>So, let's take a look at some of the code:</p>

<pre><code>// Front controller for our API

var application_root = __dirname;
var express = require("express");
var path = require("path");
var pg = require('pg');
var app = express();
var model = require('./transactionmodel');

// Create our database connection
var connectionString = "pg://chartjes:@localhost:5432/ibl_stats";

pg.connect(connectionString, function(err, client) {
  if (err) {
    console.log(err);
  }
});
var client = new pg.Client(connectionString);
var tm = new model.TransactionModel(client);

// Config things we need to get the app going
app.configure(function() {
  app.use(express.bodyParser());
  app.use(express.methodOverride());
  app.use(app.router);
  app.use(express.static(path.join(application_root, "public")));
  app.use(express.errorHandler({ dumpExceptions: true, showStack: true }));
});

app.get('/transactions/archived', function(req, res) {
  var done = function (err, transactions) {
    if(err) {
      res.send("Error querying transactions", 500);
    } else {
      res.send(transactions);
    }

  };

  var currentTransactions = tm.getArchived(done);
});

app.get('/transactions/current', function(req, res) {
  var done = function (err, transactions) {
    if(err) {
      res.send("Error querying transactions", 500);
    } else {
      res.send(transactions);
    }
  };

  var currentTransactions = tm.getCurrent(done);
});

module.exports = app;
</code></pre>

<p>I am also using the awesome <a href="http://postgresapp.com/">Postgress.app</a>
while working on this app on my laptop.</p>

<p>One of the things I learned while I started to build my tests was that if I
wanted to test stuff in isolation, I needed to alter things slightly and
export my Express "app" as a module instead of including the command 
necessary to make it run and listen for requests on a specific port.</p>

<p>Now, I did find some blog posts about how to write integration tests, but
they either wanted to use <a href="http://coffeescript.org/">CoffeeScript</a>
or was using custom modifications to the testing tools. I am not familiar
enough to write stuff like that (not in JavaScript anyway) so out of
frustration I looked at the source code of Express since <a href="http://brianstoner.com/blog/testing-in-nodejs-with-mocha/">this blog post</a>
mentioned how he created a custom version of something used to help in 
testing.</p>

<p>When I looked at the source of Express, the author had replaced a bunch
of stuff with code that simply imported SuperTest. I think I swore
really loudly at myself for not looking sooner.</p>

<p>Armed with the knowledge that I had my missing piece for the integration
test, I wrote a simple one.</p>

<pre><code>var app = require('../app');
var request = require('supertest');
var assert = require('assert');

describe('Transaction API', function() {
  it('GET /transactions/current should return 200', function(done) {
    request(app)
      .get('/transactions/current')
      .expect('Content-Type', /json/)
      .expect(200, done);
  });
});
</code></pre>

<p>It worked, which is the first step. How about another test? Let's make
sure that if we do that call to /transactions/current and verify that
we are getting back a result we expect</p>

<pre><code>it('GET /transactions/current should return expected results', function(done) {                                                                    
    var fs = require('fs');                                                     
    var currentData = fs.readFile('./current', 'utf8', function(err, data) {    
      if (err) { throw err; }                                                   
      return data;                                                              
    });                                                                         
    request(app)                                                                
      .get('/transactions/current')                                             
      .expect(currentData, done);                                               
  });                     
</code></pre>

<p>For this test, I am reading in a text file that contains, for a known database,
a JSON representation of that data. Then I do a call to my API call, and
compare the result I get back to my fixture. Just like any test I would 
write in PHP. Compare the expected to the actual.</p>

<p>In <a href="http://devhell.info/post/2012-10-06/the-grace-hopper-rape-whistle/">episode 21 of /dev/hell</a>
I talked a bit about how I felt that testing skills from one language are
transferrable to another. I think the fact that once I figured out that SuperTest
was the missing tool, it took me less than 30 minutes to write those two tests.
That includes research time reading the documentation for both Mocha and SuperTest.</p>

<p>More tests are sure to come, but I think I've found the right set of tools
for the time being.</p>

        </div>
            </article>
    <article>
        <header>
            <h2><a href="/blog/2012/10/12/grumpy-phpunit">The Grumpy Programmer&#039;s PHPUnit Cookbook</a></h2>
        </header>
        <div>
            <p>TL;DR: I've started working on <a href="http://grumpy-phpunit.com">a new book</a>.</p>

<p>Having written a book that shows you how to <a href="http://grumpy-testing.com">write code that is testable</a>
it seemed natural to write a companion book for that, to give people a better
understanding of how to use some of the testing tools.</p>

<p>To that end, I've started working on "The Grumpy Programmer's PHPUnit Cookbook"
to be released in early 2013 (I'm thinking end of January / beginning of February
if everything works out).</p>

<p>The book will be a collection of tips and tricks on how to use the gold standard
of PHP unit testing frameworks, the mighty <a href="https://github.com/sebastianbergmann/phpunit/">PHPUnit</a>. If you visit
the <a href="http://grumpy-phpunit.com">website for the book</a> you can join a mailing list
to be notified when the book is ready.</p>

<p>By joining that mailing list, you will also receive some goodies along the way 
as the book gets written. No, I'm not going to tell you what they are.</p>

<p>The book will be $25. No, I don't know how big it will be. Maybe you will end up paying 
$1 per page, but let's hope not.</p>

<p>The book will also be published through <a href="http://leanpub.com">Leanpub</a> as I am
110% happy with what they have done for me, and I encourage anyone else who wants
to write their own technical book and keep most of the money from their efforts
to consider using them.</p>

        </div>
            </article>
    <article>
        <header>
            <h2><a href="/blog/2012/10/10/happy-thoughts">Happy Thoughts</a></h2>
        </header>
        <div>
            <p>Contrary to urban legend, I do have the occasional happy thought. You can't
raise 2 little girls with a tolerant wife unless you are able to get into that
happy place almost on demand.</p>

<p>I do have friends who appear to be bottomless sources of happiness and good
cheer, their Twitter feeds full of positive messages to all. That is not my
path, but not for the reasons you might suspect.</p>

<p>I seem to generate a lot more feelings of "satisfaction" than outright 
"happiness". I also think, that being an agnostic person when it comes to organized religion, that I don't put a 
lot of stock in prayer or "the power of positive thinking" and other related
things. I also believe that Fate and Destiny plays a big role in people's lives, and
while we are in control of our day-to-day lives, you are moving down a pre-destined
path in the greater scheme of things.</p>

<p>My mother (a retired high-school teacher) always told her students that they
are "not losers, but choosers". When my thread has played out to a point 
where it intersects with someone else's, I always have to make a choice. 
So don't think I am a fatalist who believes all is pre-ordained. I believe
a wise person once said "luck is the intersection of opportunity and skill."</p>

<p>Not that I believe I am destined for greatness in any way. My programming skills
are not in the field of inventing (or reinventing) awesome pieces of technology
for the greater good of all. I am more the type that likes to combine things
together and figure out how to make something BETTER come out of all of it.</p>

<p>Hence my like for testing, and codified programming practices for a given 
language. How I like to go to conferences, and organize meet-ups, and take
time out of my after-work schedule to just shoot the shit over Skype with
people who are willing to toss away the grumpy cartoon character I play on
Twitter to talk to the person underneath it.</p>

<p>So, not a lot of happy thoughts come out of me, more like "man, I am glad
this shit worked out in a way I am satisfied with". Satisfaction IS what I
aim for, because my <a href="https://twitter.com/internet_widow">wife</a> can tell me
that I am my harshest critic, holding myself up to a pretty high standard
for whatever tasks I tackle when I am confident I can do a good job.</p>

<p>You can be happy. I'll be over here feeling satisfied.</p>

<p>Thanks to <a href="https://twitter.com/CalEvans">the icon of the PHP community</a> for
the topic suggestion.</p>

        </div>
            </article>
    <nav>
        <a href="/page/145">Newer Posts</a><br />
        <a href="/page/147">Older Posts</a><br />
    </nav>
                </div>
                <div class="span4 sidebar">
                    <div class="well">
                        <h4>@TheKeyboard <small>The ramblings of a grumpy programmer</small></h4>
                    </div>
                    <div class="well sidebar-nav">
                        <h4>Links</h4>
                        <ul class="nav">
                            <li><a href="http://sculpin.io">sculpin.io</a></li>
                            <li><a href="http://twitter.com/getsculpin">@getsculpin</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <footer class="container">
            &copy; 2014 @TheKeyboard
        </footer>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="/components/jquery/jquery.min.js"><\/script>')</script>
        <script src="/components/bootstrap/js/bootstrap.min.js"></script>
                
                <script src="/components/highlightjs/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </body>
</html>
